package net.scapeemulator.game.net.game;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.MessageBuf;
import io.netty.channel.ChannelHandlerContext;
import io.netty.handler.codec.ByteToMessageDecoder;

import java.io.IOException;

import net.scapeemulator.game.net.game.GameFrame.Type;
import net.scapeemulator.util.crypto.StreamCipher;

public final class GameFrameDecoder extends ByteToMessageDecoder {

	//Got sizes from: http://www.rune-server.org/runescape-development/rs-503-client-server/configuration/468141-550-configuration.html
	
	private static final int[] SIZES = new int[256];
	static {
	/*	SIZES[0] = 12;
        SIZES[1] = -3;
        SIZES[2] = -3;
        SIZES[3] = -3; // Attack NPC
        SIZES[4] = -3;
        SIZES[5] = -3;
        SIZES[6] = 6;
        SIZES[7] = -3;
        SIZES[8] = -3;
        SIZES[9] = -3;
        SIZES[10] = -3; // Actionbuttons #2
        SIZES[11] = -3;
        SIZES[12] = -3;
        SIZES[13] = -3;
        SIZES[14] = -3;
        SIZES[15] = -3;
        SIZES[16] = -3;
        SIZES[17] = -3;
        SIZES[18] = -3;
        SIZES[19] = -3;
        SIZES[20] = -3;
        SIZES[21] = -3;
        SIZES[22] = -3;
        SIZES[23] = -3; // Enter amount
        SIZES[24] = -3;
        SIZES[25] = -3;
        SIZES[26] = -3;
        SIZES[27] = -3; // Item on item
        SIZES[28] = -3;
        SIZES[29] = -3;
        SIZES[30] = -3; // Fourth click NPC (trade slayermaster).
        SIZES[31] = -3;
        SIZES[32] = -3;
        SIZES[33] = -3;
        SIZES[34] = -3; // Add ignore
        SIZES[35] = -3;
        SIZES[36] = -3;
        SIZES[37] = -3;
        SIZES[38] = -3;
        SIZES[39] = -3; // Walk
        SIZES[40] = -3;
        SIZES[41] = -3;
        SIZES[42] = -3;
        SIZES[43] = -3;
        SIZES[44] = -3; // Command
        SIZES[45] = -3;
        SIZES[46] = -3;
        SIZES[47] = -3;
        SIZES[48] = -3;
        SIZES[49] = -3;
        SIZES[50] = -3;
        SIZES[51] = -3;
        SIZES[52] = -3;
        SIZES[53] = -3; // Interface option #9
        SIZES[54] = -3;
        SIZES[55] = -3; // Equip item
        SIZES[56] = -3;
        SIZES[57] = -3; // Delete friend
        SIZES[58] = -3;
        SIZES[59] = -3;
        SIZES[60] = -3;
        SIZES[61] = -3;
        SIZES[62] = -3;
        SIZES[63] = -3;
        SIZES[64] = -3; // Interface option #8
        SIZES[65] = -3;
        SIZES[66] = -3;  // Pick up item
        SIZES[67] = -3;
        SIZES[68] = -3; // Attack player
        SIZES[69] = -3;
        SIZES[70] = -3;
        SIZES[71] = -3; // Trade player
        SIZES[72] = -3;
        SIZES[73] = -3;
        SIZES[74] = -3;
        SIZES[75] = 8;
        SIZES[76] = -3;
        SIZES[77] = -3; // Walk
        SIZES[78] = -3; // Second click NPC
        SIZES[79] = -3; // Swapping inventory places in shop, bank and duel
        SIZES[80] = -3;
        SIZES[81] = -3; // Unequip item
        SIZES[82] = -3;
        SIZES[83] = -3;
        SIZES[84] = -3; // Object third click
        SIZES[85] = -3;
        SIZES[86] = 6; // Screen type (fullscreen, small HD etc)
        SIZES[87] = -3;
        SIZES[88] = -3;
        SIZES[89] = -3;
        SIZES[90] = -3;
        SIZES[91] = -3;
        SIZES[92] = 7; // Object first click.
        SIZES[93] = -3;
        SIZES[94] = 6; // Extended button
        SIZES[95] = -3;
        SIZES[96] = -3;
        SIZES[97] = -3;
        SIZES[98] = -3; // Toggle sound setting
        SIZES[99] = -3; // ?
        SIZES[100] = -3;
        SIZES[101] = -3;
        SIZES[102] = -3;
        SIZES[103] = -3;
        SIZES[104] = -3; // Join clan chat
        SIZES[105] = -3;
        SIZES[106] = -3; // Follow player
        SIZES[107] = -3;
        SIZES[108] = -3;
        SIZES[109] = -3;
        SIZES[110] = -3;
        SIZES[111] = -3; // Grand Exchange item search
        SIZES[112] = -3;
        SIZES[113] = 0; // Region loading, size varies
        SIZES[114] = -3;
        SIZES[115] = -3; // Use item on npc
        SIZES[116] = -3;
        SIZES[117] = -3;
        SIZES[118] = -3;
        SIZES[119] = -3;
        SIZES[120] = -3; // Add friend
        SIZES[121] = -3;
        SIZES[122] = -3;
        SIZES[123] = -3;
        SIZES[124] = -3; //Interface option #3
        SIZES[125] = -3;
        SIZES[126] = -3;
        SIZES[127] = -3;
        SIZES[128] = -3;
        SIZES[129] = -3;
        SIZES[130] = -3;
        SIZES[131] = -3;
        SIZES[132] = -3; // Actionbuttons #3
        SIZES[133] = -3;
        SIZES[134] = -3; // Item on object
        SIZES[135] = -3; // Drop item
        SIZES[136] = -3;
        SIZES[137] = 0;  // Ping
        SIZES[138] = -3;
        SIZES[139] = -3;
        SIZES[140] = 4; // Camera message
        SIZES[141] = -3;
        SIZES[142] = -3;
        SIZES[143] = -3;
        SIZES[144] = -3;
        SIZES[145] = -3;
        SIZES[146] = -3;
        SIZES[147] = -3;
        SIZES[148] = -3; // Third click NPC
        SIZES[149] = -3;
        SIZES[150] = -3;
        SIZES[151] = -3;
        SIZES[152] = -3;
        SIZES[153] = -3; // Inventory click item #2 (check RC pouch)
        SIZES[154] = -3;
        SIZES[155] = -3;
        SIZES[156] = 2; // Last received unique packet id
        SIZES[157] = -3; // Privacy options
        SIZES[158] = 4; // Actionbutton
        SIZES[159] = -3;
        SIZES[160] = -3;
        SIZES[161] = -3; // Item right click option #1 (rub/empty)
        SIZES[162] = -3; // Clan chat kick
        SIZES[163] = -3;
        SIZES[164] = -3;
        SIZES[165] = -3;
        SIZES[166] = -3; // Interface option #7
        SIZES[167] = -3;
        SIZES[168] = -3; // Interface option #6
        SIZES[169] = -3;
        SIZES[170] = -3;
        SIZES[171] = -3;
        SIZES[172] = -3;
        SIZES[173] = -3;
        SIZES[174] = -3;
        SIZES[175] = -3;
        SIZES[176] = -3;
        SIZES[177] = -3; // Junk, no real purpose
        SIZES[178] = -3;
        SIZES[179] = -3;
        SIZES[180] = -3; // Accept trade (chatbox)
        SIZES[181] = -3;
        SIZES[182] = -3;
        SIZES[183] = -3;
        SIZES[184] = -3; // Close interface
        SIZES[185] = -3;
        SIZES[186] = -3;
        SIZES[187] = -3;
        SIZES[188] = -3; // Clan ranks
        SIZES[189] = -3;
        SIZES[190] = -3;
        SIZES[191] = -3;
        SIZES[192] = -3;
        SIZES[193] = -3;
        SIZES[194] = -3; // Object second click
        SIZES[195] = -3; // Magic on player
        SIZES[196] = -3; // Interface option #2
        SIZES[197] = -3;
        SIZES[198] = -3;
        SIZES[199] = -3; //Interface option #4
        SIZES[200] = 6; // Mouse click
        SIZES[201] = -1; // Send PM
        SIZES[202] = -3;
        SIZES[203] = -3;
        SIZES[204] = -3;
        SIZES[205] = -3;
        SIZES[206] = -3; // Operate item
        SIZES[207] = 20; // Minimap walk
        SIZES[208] = -3;
        SIZES[209] = -3;
        SIZES[210] = -3;
        SIZES[211] = -3;
        SIZES[212] = -3;
        SIZES[213] = -3; // Delete ignore
        SIZES[214] = -3;
        SIZES[215] = -1; // Walk
        SIZES[216] = -3;
        SIZES[217] = -3;
        SIZES[218] = -3; // Fifth click NPC
        SIZES[219] = -3;
        SIZES[220] = -3;
        SIZES[221] = -3;
        SIZES[222] = -3;
        SIZES[223] = -3;
        SIZES[224] = -3;
        SIZES[225] = -3;
        SIZES[226] = -3;
        SIZES[227] = -3;
        SIZES[228] = -3;
        SIZES[229] = -3;
        SIZES[230] = 6; // GameScreen Walk
        SIZES[231] = -3; // Swap item slot
        SIZES[232] = -3;
        SIZES[233] = -3;
        SIZES[234] = -3; //Interface option #5
        SIZES[235] = -3;
        SIZES[236] = 4; // Sent during region load when not in applet.
        SIZES[237] = -1; // Public chat
        SIZES[238] = -3;
        SIZES[239] = -3; // Magic on NPC
        SIZES[240] = -3;
        SIZES[241] = -3;
        SIZES[242] = -3;
        SIZES[243] = -3;
        SIZES[244] = -3; // Enter text
        SIZES[245] = -3; // Idle logout
        SIZES[246] = -3;
        SIZES[247] = -3; // Object 4th option
        SIZES[248] = 1; // Focus
        SIZES[249] = -3;
        SIZES[250] = -3;
        SIZES[251] = -3;
        SIZES[252] = -3;
        SIZES[253] = -3;
        SIZES[254] = -3; // First click object
        SIZES[255] = -3;
        
        //TODO: Check override?
        SIZES[142] = 8;
		SIZES[172] = 8; 
		SIZES[215] = 9; 
		SIZES[26] = 8;
		SIZES[197] = 8; 
		SIZES[17] = 0;
		SIZES[218] = 8;
		SIZES[230] = 6;
		SIZES[207] = 6;
		SIZES[218] = 8;
		SIZES[86] = 6;
		SIZES[236] = 4;
		SIZES[113] = 0;
		SIZES[75] = 8;
		SIZES[178] = 6;
		SIZES[119] = 15;
		SIZES[3] = 7;
		SIZES[92] = 7;
		SIZES[158] = 4;
		SIZES[96] = 3;
		SIZES[116] = 15;
		SIZES[60] = 7;
		SIZES[37] = 3;
		SIZES[242] = 8;
		SIZES[40] = 12;
		SIZES[134] = 7;
		SIZES[72] = 2;
		SIZES[160] = 11;
		SIZES[224] = 9;
		SIZES[123] = 11;
		SIZES[4] = 3;
		SIZES[212] = 3;
		SIZES[77] = 3;
		SIZES[155] = 9;
		SIZES[177] = 14;
		SIZES[28] = 13;
		SIZES[33] = 3;
		SIZES[89] = 13;
		SIZES[232] = 7;
		SIZES[148] = 3;
		SIZES[176] = 2;
		SIZES[52] = 3;
		SIZES[245] = 3;
		SIZES[54] = 7;
		SIZES[103] = 8;
		SIZES[103] = 3;
		SIZES[95] = 8;
		SIZES[145] = 8;
		SIZES[65] = 2;
		SIZES[48] = 7;
		SIZES[53] = 3;
		SIZES[8] = 7;
		SIZES[81] = 8;
		SIZES[102] = 8;
		SIZES[159] = 7;
		SIZES[124] = 8;
		SIZES[223] = 3;
		SIZES[12] = 3;
		SIZES[158] = 4;
		SIZES[85] = 4;
		SIZES[72] = 2;
		SIZES[58] = 16;
		SIZES[205] = 8;
		SIZES[227] = 7;
		SIZES[204] = 10;
		SIZES[158] = 4;
		SIZES[214] = 8;
		SIZES[88] = 8;
		SIZES[189] = 0;
		SIZES[250] = 4;
		SIZES[216] = -1;
		SIZES[199] = -1;
		SIZES[200] = 6;
		SIZES[140] = 4;
		SIZES[248] = 1;
		SIZES[120] = 4;
		SIZES[6] = 9;
		SIZES[85] = 4;
		SIZES[204] = 10;
		SIZES[91] = 0;
		SIZES[137] = 0;
		SIZES[94] = 6;
		SIZES[201] = 6;
		SIZES[30] = 6;
		SIZES[61] = 6;
		SIZES[66] = 6;
		SIZES[7] = 6;
		SIZES[108] = 6;
		SIZES[255] = 6;
		SIZES[97] = 6;
		SIZES[10] = 6;
		SIZES[137] = 0;
		SIZES[212] = 3;
		SIZES[105] = 3;
		SIZES[96] = 3;
		SIZES[52] = 3;
		SIZES[77] = 3;
		SIZES[251] = 4;
		SIZES[0] = 12;
		SIZES[215] = 9;
		SIZES[219] = 4;
		SIZES[149] = 8;
		SIZES[149] = -1;
		SIZES[231] = 2;
		SIZES[234] = 3;
		SIZES[90] = 10;
		SIZES[186] = -1;
		SIZES[157] = -1;
		SIZES[222] = -1;
		SIZES[42] = -1;
		SIZES[243] = -1;
		SIZES[78] = -1;*/
		
		SIZES[0] = 12;
		SIZES[1] = 0;
		SIZES[2] = 0;
		SIZES[3] = 7;
		SIZES[4] = 3;
		SIZES[5] = 0;
		SIZES[6] = 9;
		SIZES[7] = 6;
		SIZES[8] = 7;
		SIZES[9] = 0;
		SIZES[10] = 6;
		SIZES[11] = 0;
		SIZES[12] = 3;
		SIZES[13] = 0;
		SIZES[14] = 0;
		SIZES[15] = 0;
		SIZES[16] = 0;
		SIZES[17] = 0;
		SIZES[18] = 0;
		SIZES[19] = 0;
		SIZES[20] = 0;
		SIZES[21] = 0;
		SIZES[22] = 0;
		SIZES[23] = 0;
		SIZES[24] = 0;
		SIZES[25] = 0;
		SIZES[26] = 8;
		SIZES[27] = 0;
		SIZES[28] = 13;
		SIZES[29] = 0;
		SIZES[30] = 6;
		SIZES[31] = 0;
		SIZES[32] = 0;
		SIZES[33] = 3;
		SIZES[34] = 0;
		SIZES[35] = 0;
		SIZES[36] = 0;
		SIZES[37] = 3;
		SIZES[38] = 0;
		SIZES[39] = 0;
		SIZES[40] = 12;
		SIZES[41] = 0;
		SIZES[42] = -1;
		SIZES[43] = 0;
		SIZES[44] = 0;
		SIZES[45] = 0;
		SIZES[46] = 0;
		SIZES[47] = 0;
		SIZES[48] = 7;
		SIZES[49] = 0;
		SIZES[50] = 0;
		SIZES[51] = 0;
		SIZES[52] = 3;
		SIZES[53] = 3;
		SIZES[54] = 7;
		SIZES[55] = 0;
		SIZES[56] = 0;
		SIZES[57] = 0;
		SIZES[58] = 16;
		SIZES[59] = 0;
		SIZES[60] = 7;
		SIZES[61] = 6;
		SIZES[62] = 0;
		SIZES[63] = 0;
		SIZES[64] = 0;
		SIZES[65] = 2;
		SIZES[66] = 6;
		SIZES[67] = 0;
		SIZES[68] = 0;
		SIZES[69] = 0;
		SIZES[70] = 0;
		SIZES[71] = 0;
		SIZES[72] = 2;
		SIZES[73] = 0;
		SIZES[74] = 0;
		SIZES[75] = 8;
		SIZES[76] = 0;
		SIZES[77] = 3;
		SIZES[78] = -1;
		SIZES[79] = 0;
		SIZES[80] = 0;
		SIZES[81] = 8;
		SIZES[82] = 0;
		SIZES[83] = 0;
		SIZES[84] = 0;
		SIZES[85] = 4;
		SIZES[86] = 6;
		SIZES[87] = 0;
		SIZES[88] = 8;
		SIZES[89] = 13;
		SIZES[90] = 10;
		SIZES[91] = 0;
		SIZES[92] = 7;
		SIZES[93] = 0;
		SIZES[94] = 6;
		SIZES[95] = 8;
		SIZES[96] = 3;
		SIZES[97] = 6;
		SIZES[98] = 0;
		SIZES[99] = 0;
		SIZES[100] = 0;
		SIZES[101] = 0;
		SIZES[102] = 8;
		SIZES[103] = 8; //8? 3
		SIZES[104] = 0;
		SIZES[105] = 3;
		SIZES[106] = 0;
		SIZES[107] = 0;
		SIZES[108] = 6;
		SIZES[109] = 0;
		SIZES[110] = 0;
		SIZES[111] = 0;
		SIZES[112] = 0;
		SIZES[113] = 0;
		SIZES[114] = 0;
		SIZES[115] = 0;
		SIZES[116] = 15;
		SIZES[117] = 0;
		SIZES[118] = 0;
		SIZES[119] = 15;
		SIZES[120] = 4;
		SIZES[121] = 0;
		SIZES[122] = 0;
		SIZES[123] = 11;
		SIZES[124] = 8;
		SIZES[125] = 0;
		SIZES[126] = 0;
		SIZES[127] = 0;
		SIZES[128] = 0;
		SIZES[129] = 0;
		SIZES[130] = 0;
		SIZES[131] = 0;
		SIZES[132] = 0;
		SIZES[133] = 0;
		SIZES[134] = 7;
		SIZES[135] = 0;
		SIZES[136] = 0;
		SIZES[137] = 0;
		SIZES[138] = 0;
		SIZES[139] = 0;
		SIZES[140] = 4;
		SIZES[141] = 0;
		SIZES[142] = 8;
		SIZES[143] = 0;
		SIZES[144] = 0;
		SIZES[145] = 8;
		SIZES[146] = 0;
		SIZES[147] = 0;
		SIZES[148] = 3;
		SIZES[149] = -1;
		SIZES[150] = 0;
		SIZES[151] = 0;
		SIZES[152] = 0;
		SIZES[153] = 0;
		SIZES[154] = 0;
		SIZES[155] = 9;
		SIZES[156] = 2;
		SIZES[157] = -1;
		SIZES[158] = 4;
		SIZES[159] = 7;
		SIZES[160] = 11;
		SIZES[161] = 0;
		SIZES[162] = 0;
		SIZES[163] = 0;
		SIZES[164] = 0;
		SIZES[165] = 0;
		SIZES[166] = 0;
		SIZES[167] = 0;
		SIZES[168] = 0;
		SIZES[169] = 0;
		SIZES[170] = 0;
		SIZES[171] = 0;
		SIZES[172] = 8;
		SIZES[173] = 0;
		SIZES[174] = 0;
		SIZES[175] = 0;
		SIZES[176] = 2;
		SIZES[177] = 14;
		SIZES[178] = 6;
		SIZES[179] = 0;
		SIZES[180] = 0;
		SIZES[181] = 0;
		SIZES[182] = 0;
		SIZES[183] = 0;
		SIZES[184] = 0;
		SIZES[185] = 0;
		SIZES[186] = -1;
		SIZES[187] = 0;
		SIZES[188] = 0;
		SIZES[189] = 0;
		SIZES[190] = 0;
		SIZES[191] = 0;
		SIZES[192] = 0;
		SIZES[193] = 0;
		SIZES[194] = 0;
		SIZES[195] = 0;
		SIZES[196] = 0;
		SIZES[197] = 8;
		SIZES[198] = 0;
		SIZES[199] = -1;
		SIZES[200] = 6;
		SIZES[201] = -1;
		SIZES[202] = 0;
		SIZES[203] = 0;
		SIZES[204] = 10;
		SIZES[205] = 8;
		SIZES[206] = 0;
		SIZES[207] = 20;
		SIZES[208] = 0;
		SIZES[209] = 0;
		SIZES[210] = 0;
		SIZES[211] = 0;
		SIZES[212] = 3;
		SIZES[213] = 0;
		SIZES[214] = 8;
		SIZES[215] = -1;
		SIZES[216] = -1;
		SIZES[217] = 0;
		SIZES[218] = 8;
		SIZES[219] = 4;
		SIZES[220] = 0;
		SIZES[221] = 0;
		SIZES[222] = 4; //-1
		SIZES[223] = 3;
		SIZES[224] = 9;
		SIZES[225] = 0;
		SIZES[226] = 0;
		SIZES[227] = 7;
		SIZES[228] = 0;
		SIZES[229] = 0;
		SIZES[230] = 6;
		SIZES[231] = 2;
		SIZES[232] = 7;
		SIZES[233] = 0;
		SIZES[234] = 3;
		SIZES[235] = 0;
		SIZES[236] = 4;
		SIZES[237] = -1;
		SIZES[238] = 0;
		SIZES[239] = 0;
		SIZES[240] = 0;
		SIZES[241] = 0;
		SIZES[242] = 8;
		SIZES[243] = -1;
		SIZES[244] = 0;
		SIZES[245] = 3;
		SIZES[246] = 0;
		SIZES[247] = 0;
		SIZES[248] = 1;
		SIZES[249] = 0;
		SIZES[250] = 4;
		SIZES[251] = 4;
		SIZES[252] = 0;
		SIZES[253] = 0;
		SIZES[254] = 0;
		SIZES[255] = 6;
	}

	private enum State {
		READ_OPCODE, READ_SIZE, READ_PAYLOAD
	}

	private final StreamCipher cipher;
	private State state = State.READ_OPCODE;
	private boolean variable;
	private int opcode, size;

	public GameFrameDecoder(StreamCipher cipher) {
		this.cipher = cipher;
	}

	@Override
	public void decode(ChannelHandlerContext ctx, ByteBuf buf, MessageBuf<Object> out) throws Exception {
		if (state == State.READ_OPCODE) {
			if (!buf.isReadable())
				return;

			opcode = (buf.readUnsignedByte() - cipher.nextInt()) & 0xFF;
			size = SIZES[opcode];
			
			if (size == -3)
				throw new IOException("Illegal opcode " + opcode + ".");

			variable = size == -1;
			state = variable ? State.READ_SIZE : State.READ_PAYLOAD;
		}

		if (state == State.READ_SIZE) {
			if (!buf.isReadable())
				return;

			size = buf.readUnsignedByte();
			state = State.READ_PAYLOAD;
		}

		if (state == State.READ_PAYLOAD) {
			if (buf.readableBytes() < size)
				return;

			ByteBuf payload = buf.readBytes(size);
			state = State.READ_OPCODE;

			out.add(new GameFrame(opcode, variable ? Type.VARIABLE_BYTE : Type.FIXED, payload));
		}
	}

}
